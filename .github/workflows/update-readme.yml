name: è‡ªåŠ¨æ›´æ–°README

on:
  push:
    paths:
      - '_posts/**'
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å…³é”®é…ç½®
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3

      - name: è®¾ç½®Rubyç¯å¢ƒ
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'
          bundler-cache: true

      - name: å®‰è£…ä¾èµ–
        run: |
          gem install jekyll jekyll-feed jekyll-paginate

      - name: ç”Ÿæˆè®ºæ–‡åˆ—è¡¨
        run: |
          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶å­˜å‚¨è®ºæ–‡åˆ—è¡¨
          echo "# ğŸ“š å°ç»„å†…è®ºæ–‡åˆ†äº«" > temp_readme.md
          echo "" >> temp_readme.md
          echo "åœ¨è¿™é‡Œè®°å½•æˆ‘ä»¬å°ç»„å†…çš„è®ºæ–‡åˆ†äº«å’Œè®¨è®ºã€‚æ¯å‘¨æ›´æ–°ã€‚" >> temp_readme.md
          echo "" >> temp_readme.md
          echo "### ğŸŒŸ 2025å¹´æ˜¥å­£å­¦æœŸ" >> temp_readme.md
          echo "" >> temp_readme.md
          echo "| æ—¥æœŸ | æ±‡æŠ¥äºº | è®ºæ–‡ |" >> temp_readme.md
          echo "| :---: |:--------------:|:------------------------------------------------------------------------------------------------------------------------------------------------------------------:|" >> temp_readme.md
          
          # ä»_postsç›®å½•è¯»å–è®ºæ–‡ä¿¡æ¯å¹¶æ·»åŠ åˆ°README
          for file in _posts/*.md; do
            if [ -f "$file" ]; then
              date=$(grep -m 1 "date:" "$file" | sed 's/date: //' | tr -d '\r')
              presenter=$(grep -m 1 "presenter:" "$file" | sed 's/presenter: //' | sed 's/"//g' | tr -d '\r')
              title=$(grep -m 1 "title:" "$file" | sed 's/title: //' | sed 's/"//g' | tr -d '\r')
              journal=$(grep -m 1 "journal:" "$file" | sed 's/journal: //' | sed 's/"//g' | tr -d '\r')
              link=$(grep -m 1 "original_link:" "$file" | sed 's/original_link: //' | sed 's/"//g' | tr -d '\r')
              
              # è·å–æ–‡ä»¶åï¼ˆä¸å«è·¯å¾„å’Œæ‰©å±•åï¼‰
              filename=$(basename "$file" .md)
              
              # æ„å»ºGitHub Pagesé“¾æ¥
              gh_pages_link="https://shixuan7.github.io/ahu-test/papers/${filename#*-*-*-}"
              
              # æ ¼å¼åŒ–æ—¥æœŸ
              formatted_date=$(date -d "$date" +"%Y.%m.%d" 2>/dev/null || echo "$date")
              
              # æ·»åŠ åˆ°README
              echo "| $formatted_date | $presenter | [$title]($gh_pages_link) ($journal) |" >> temp_readme.md
            fi
          done
          
          # æ·»åŠ åˆ†äº«è§„åˆ™
          echo "" >> temp_readme.md
          echo "" >> temp_readme.md
          echo "### ğŸ“‹ åˆ†äº«è§„åˆ™" >> temp_readme.md
          echo "1. â° æ¯å‘¨å››ä¸Šåˆ8:00-11:00è¿›è¡Œç»„ä¼šæŠ¥å‘Š" >> temp_readme.md
          echo "2. ğŸ“Š æ¯äººæ¯æ¬¡åˆ†äº«1ç¯‡è®ºæ–‡ï¼Œæ§åˆ¶æ—¶é—´åœ¨20-30åˆ†é’Ÿ" >> temp_readme.md
          echo "3. ğŸ“ åˆ†äº«å†…å®¹åŒ…æ‹¬ä½†ä¸é™äºï¼š" >> temp_readme.md
          echo "   - ğŸ” è®ºæ–‡çš„æ ¸å¿ƒåˆ›æ–°ç‚¹" >> temp_readme.md
          echo "   - ğŸ› ï¸ æ–¹æ³•çš„æŠ€æœ¯ç»†èŠ‚" >> temp_readme.md
          echo "   - ğŸ“ˆ å®éªŒç»“æœåˆ†æ" >> temp_readme.md
          echo "   - ğŸ’¡ ä¸ªäººè§è§£ä¸æ€è€ƒ" >> temp_readme.md
          echo "4. ğŸ¤ é¼“åŠ±ç§¯æè®¨è®ºï¼Œæå‡ºé—®é¢˜å’Œå»ºè®®" >> temp_readme.md
          echo "---" >> temp_readme.md
          echo "" >> temp_readme.md
          echo "> ğŸ’« æ¬¢è¿å¤§å®¶ç§¯æå‚ä¸ç»„ä¼šè®¨è®ºï¼å¦‚æœ‰ä»»ä½•å»ºè®®ï¼Œè¯·éšæ—¶æå‡ºã€‚" >> temp_readme.md
          
          # æ›¿æ¢README.md
          mv temp_readme.md README.md

      - name: æäº¤æ›´æ–°çš„README
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git commit -m "è‡ªåŠ¨æ›´æ–°è®ºæ–‡åˆ—è¡¨ [skip ci]" || echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
